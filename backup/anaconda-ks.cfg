# Kickstart file automatically generated by anaconda.

#version=DEVEL
install
url --url=http://tns-cobbler-bris.tse.int/cblr/links/RHEL-6u2-x86_64
lang en_AU
keyboard us
network --onboot yes --device eth0 --mtu=1500 --bootproto dhcp
rootpw  --iscrypted $6$rHJPXAQv$Zj3tGgb1Yn2RNoZSGz694oSuK6.kVRQFKq1dGNXaSsRiv5rZ.H7R/1/6FZNHiN5XWmMojsLm/XjXYS3P6aQgA.
# Reboot after installation
reboot
firewall --service=ssh
authconfig --useshadow  --enablemd5 --passalgo=sha512 --enableldap --enablekrb5 --enableldapauth --ldapbasedn=dc=tse,dc=int --ldapserver=ldap://pm02mgtipa03v.tse.int/,ldap://pm02mgtipa03v.tse.int/ --krb5realm=TSE.INT --enablekrb5kdcdns --enablekrb5realmdns --enablecache
selinux --enforcing
timezone UTC
bootloader --location=mbr --driveorder=sda --append=" rhgb crashkernel=auto quiet"
# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work
#clearpart --all --initlabel

#part /boot --fstype=ext4 --size=200
#part pv.008002 --grow --size=8192

#volgroup vg0 --pesize=32768 pv.008002
#logvol /opt --fstype=ext4 --name=lv_opt --vgname=vg0 --grow --size=5120 --maxsize=20480
#logvol / --fstype=ext4 --name=lv_root --vgname=vg0 --grow --size=8192 --maxsize=20480
#logvol swap --name=lv_swap --vgname=vg0 --size=2048

repo --name="Red Hat Enterprise Linux"  --baseurl=http://tns-cobbler-bris.tse.int/cblr/links/RHEL-6u2-x86_64 --cost=100
repo --name="epel-6-x86_64"  --baseurl=http://bne-mrepo-01.tse.int/mrepo/rhel6s-x86_64/RPMS.epel/ --cost=1000
repo --name="rhel-6-x86_64-base"  --baseurl=http://bne-mrepo-01.tse.int/mrepo/rhel6s-x86_64/RPMS.os/ --cost=1000
repo --name="rhel-6-x86_64-optional"  --baseurl=http://bne-mrepo-01.tse.int/mrepo/rhel6s-x86_64/RPMS.optional/ --cost=1000
repo --name="rhel-6-x86_64-updates"  --baseurl=http://bne-mrepo-01.tse.int/mrepo/rhel6s-x86_64/RPMS.updates/ --cost=1000

%packages
@Base
@Core
nss-pam-ldapd
openssl-perl
pam_krb5
puppet
redhat-lsb

%end

%pre
set -x -v
exec 1>/tmp/ks-pre.log 2>&1

# Once root's homedir is there, copy over the log.
while : ; do
    sleep 10
    if [ -d /mnt/sysimage/root ]; then
        cp /tmp/ks-pre.log /mnt/sysimage/root/
        logger "Copied %pre section log to system"
        break
    fi
done &

$kickstart_start

# Enable installation monitoring
wget -O /tmp/anamon "http://tns-cobbler-bris.tse.int:80/cobbler/aux/anamon"
python /tmp/anamon --name "RHEL-6u2-x86_64" --server "tns-cobbler-bris.tse.int" --port "80"


%end

%post
set -x -v
exec 1>/root/ks-post.log 2>&1

# Start yum configuration 
wget "http://tns-cobbler-bris.tse.int/cblr/svc/op/yum/profile/RHEL-6u2-x86_64" --output-document=/etc/yum.repos.d/cobbler-config.repo

# End yum configuration



# Start post_install_network_config generated code
# End post_install_network_config generated code




# Start download cobbler managed config files (if applicable)
# End download cobbler managed config files (if applicable)

# Start koan environment setup
echo "export COBBLER_SERVER=tns-cobbler-bris.tse.int" > /etc/profile.d/cobbler.sh
echo "setenv COBBLER_SERVER tns-cobbler-bris.tse.int" > /etc/profile.d/cobbler.csh
# End koan environment setup

# begin Red Hat management server registration
# not configured to register to any Red Hat management server (ok)
# end Red Hat management server registration

# Begin cobbler registration
if [ -f "/usr/bin/cobbler-register" ]; then
    cobbler-register --server=tns-cobbler-bris.tse.int --fqdn '*AUTO*' --profile=RHEL-6u2-x86_64 --batch
fi
# End cobbler registration

# Create the standard banner
echo "**** WARNING ****

AUTHORISED USERS ONLY!
The information on this computer and network is the intellectual property of a
private corporation and is protected by intellectual property rights. You must
be assigned an account on this computer to access information and are only
allowed to access information as defined by the system administrators. Your
activities may be monitored. Use of this computer implies consent to monitoring.

" > /etc/motd

perl -pi -e 's/#PUPPET_SERVER=puppet/PUPPET_SERVER=tns-puppet01-bris.tse.int/i' /etc/sysconfig/puppet

chkconfig --add puppet
chkconfig puppet on


#!/bin/sh

if [ -f /usr/sbin/authconfig ]; then
 /usr/sbin/authconfig --enablemkhomedir --update
fi
echo "mfleming built this nasty hack for pre-puppeted boxes" >> /etc/pam_ldap.conf
echo "nss_base_passwd cn=users,cn=accounts,dc=tse,dc=int?sub" >> /etc/pam_ldap.conf
##!/bin/bash

if [ ! -e /lib/modules/`uname -r`/misc/.vmware_installed ]; then
        /usr/bin/vmware-config-tools.pl --default
        touch /lib/modules/`uname -r`/misc/.vmware_installed
fi


# Enable post-install boot notification

wget -O /usr/local/sbin/anamon "http://tns-cobbler-bris.tse.int:80/cobbler/aux/anamon"
wget -O /etc/rc.d/init.d/anamon "http://tns-cobbler-bris.tse.int:80/cobbler/aux/anamon.init"

chmod 755 /etc/rc.d/init.d/anamon /usr/local/sbin/anamon
test -d /selinux && restorecon /etc/rc.d/init.d/anamon /usr/local/sbin/anamon

chkconfig --add anamon

cat << __EOT__ > /etc/sysconfig/anamon
COBBLER_SERVER="tns-cobbler-bris.tse.int"
COBBLER_PORT="80"
COBBLER_NAME="RHEL-6u2-x86_64"
LOGFILES="/var/log/boot.log /var/log/messages /var/log/dmesg"
__EOT__


# Start final steps
$kickstart_done
# End final steps
%end
